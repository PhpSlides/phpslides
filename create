#!/usr/bin/env php
<?php

// Function to output colored text
function style(string $text, string $colorCode) {
   return "\033[" . $colorCode . "m" . $text . "\033[0m";
}

// Define the host and port for the built-in server
$host = '127.0.0.1';
$port = '2200';

// Function to check if a port is in use
function isPortInUse($host, $port) {
   $connection = @fsockopen($host, $port);
   if (is_resource($connection)) {
      fclose($connection);
      return true;
   }
   return false;
}

// Check if the port is already in use
if (isPortInUse($host, $port)) {
   echo style("Error: ", '37;41');
   echo style(" Port $port is already in use.\n", '37;1');
   exit(1);
}

// Command to start the PHP built-in server with the router script
$command = sprintf('php -S %s:%s -t src/bootstrap/ src/bootstrap/app.php 2>&1 > /dev/null & echo $!', $host, $port);

// Display a message to the user
echo style("Started server at http://$host:$port\n", '37;1');
echo style("Press Ctrl+C to stop the server.\n", '37;46');

// Run the command to start the server and get the process ID
$pid = exec($command);

// Function to stop the server when the script is terminated
function stopServer($pid) {
   exec("kill $pid");
   echo "Server stopped.\n";
}

// Register the stopServer function to be called on script termination
register_shutdown_function('stopServer', $pid);

// Keep the script running to allow the shutdown function to be called
while (true) {
   sleep(1);
}